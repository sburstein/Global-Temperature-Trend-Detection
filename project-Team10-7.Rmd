---
title: "Project - Team 10-7"
author: "The Outliers: Morgan Pruchniewski, Scott Burstein, Katie Zhou"
date: "10/6/2020"
output: 
  pdf_document: default
  html_document: default
---

```{r setup, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse) 
library(lubridate)
library(maps)
library(sp)
```
# Introduction

One of the biggest environmental issues facing our planet has been climate
change. As fossil fuel emissions have increased, greenhouse gases have begun
trapping heat in our atmosphere that has created severe impacts. These include
increased global temperature and rising ocean levels, in addition to increased
natural disasters (https://climate.nasa.gov/effects/).
(https://www.usgs.gov/faqs/how-can-climate-change-affect-natural-disasters-1?
qt-news_science_products=0#qt-news_science_products)

Climate change is a significant issue that has also become a hot-button 
political topic in recent years because of the failure of certain individuals, 
political parties, and corporations to take action: some people do in fact deny 
the existence of climate change/global warming despite a strong body of 
scientific support. 
(https://www.sciencealert.com/the-five-corrupt-pillars-of-climate-change-denial) 
The main argument behind this is that the Earth is always 
changing, and that the recent increase in global land and ocean temperatures
is not significant enough to support global warming.

In this report, we will be analyzing a dataset containing recorded land and 
ocean temperatures over the last 100+ years to examine whether there is evidence 
to suggest a statistically significant increase in land temperature over the 
last 30 years. 

### Research Questions:
Our main research question will be:  
**Is there significant evidence to support the existence of climate change?**  

To evaluate this, we will conduct three general hypothesis tests:

First, we will examine whether there is a statistically significant difference 
between the mean earth surface temperature since 1980 and the mean earth surface 
temperature over the entire 20th century.  

Our hypotheses for this question are as follows:
$H_o$: The mean earth surface temperature in recent years (1980-2013) is not 
greater than the mean earth surface temperature throughout the 20th century.  

$H_a$: The mean earth surface temperature in recent years (1980-2013) is greater 
than the mean earth surface temperature throughout the 20th century.  


Additionally, we will examine whether the rate of land temperature change is 
different now than it may have been in earlier years.

Our hypotheses for this question are as follows:
$H_o$: The global average earth surface temperature changed at the same rate 
from 1975-2013 as it did from 1900-1925.

$H_a$: The global average earth surface temperature changed at a greater rate 
from 1975-2013 than it did from 1900-1925.



We will also how the changes in earth surface temperature differ geographically, 
testing if there are regions where climate change seems to have a greater 
effect.  

Our hypotheses for this question are as follows:
$H_o$: All geographical regions have experienced the same mean change in earth 
surface temperature.

$H_a$: Some regions have experienced higher mean changes in earth surface 
temperature (we will explore which regions, if any, later in this report).

### The Data:
We found this dataset on Kaggle (https://www.kaggle.com/berkeleyearth/climate-change-earth-surface-temperature-data).
The data was originally compiled by the Berkeley Earth Data Lab from 
16 pre-existing archives, and it was updated to Kaggle in 2017. It is important
to note that many of the earlier years include NA values, which is why we 
focused on analysis on the 1900s.

### The Cases:

**(By Time and Location (for `GlobalLandTemperaturesByMajorCity`))**

Each observation in `GlobalLandTemperaturesByMajorCity` is a city and its 
respective land temperature, coordinates, and Country, which will be used to 
investigate changes in climate over time. There are 239,177 rows in the major 
city dataset. 

**(By Time (for `GlobalLandTemperaturesByMajorCity`))**

Each observation in `GlobalTemperatures` is a numeric date/time value 
(described below) and its respective land temperature, max temperature, 
min temperature, ocean temperature, and relevant uncertainties to said 
variables, which will be used to investigate changes in climate over time. 
There are 3,192 rows in the global dataset. 

### Relevant Variables:

The relevant variables in the `major_city` dataset include dt (date and time of 
the recorded temperature, a discrete numeric), AverageTemperature (the average 
temperature for each city, a continuous numeric), city (nominal categorical), 
country (nominal categorical), latitude (continuous numeric), and longitude 
(continuous numeric).

The relevant variables in the `global` dataset include dt (date and time of the 
recorded temperature, a discrete numeric), LandAverageTemperature (the average 
global land temperature at that time, continuous numeric), LandMaxTemperature 
(the highest recorded land temperature of that year, a continuous numeric), 
LandMinTemperature (the lowest recorded land temperature of that year, a 
continous numeric), and LandAndOceanAverageTemperature (the average of land and 
ocean temperature averages for that year, a continuous numeric).

```{r read-in-data, message = FALSE, echo = FALSE}
#read in datasets
major_city <- read_csv("data/GlobalLandTemperaturesByMajorCity.csv")
global <- read_csv("data/GlobalTemperatures.csv",
                    col_types = "Tdddddddd")
df <- left_join(major_city, global) 
```

```{r data-processing, echo = FALSE}
df$lat<-as.numeric(gsub("N|E|S|W", "",df$Latitude))*
  ifelse(grepl("S",df$Latitude),-1,1)

df$long<-as.numeric(gsub("N|E|S|W", "",df$Longitude))*
  ifelse(grepl("W",df$Longitude),-1,1)

df <- df %>%
  mutate(month = month(dt),
         year = year(dt),
         season = case_when(
           month < 3 | month == 12 ~ "winter",
           month >= 3 & month < 6 ~ "spring",
           month >=6 & month < 9 ~ "summer",
           month >= 9 & month < 12 ~ "autumn"
         )) 

df$Country <- replace(df$Country, df$Country=="Congo (Democratic Republic Of The)","Congo")
 
```


### Methodology

***Initial visualizations:***
```{r visualization-by-season, echo = FALSE}
ggplot(data=df, aes(
  x=dt, y=LandAverageTemperature
)) +
  geom_point(aes(color=season)) + 
  labs(title = "Global average land temperature since 1900",
       x = "Year",
       y = "Average Land Temp.")

```
Based on this initial visualization, there seems to be a high amount of uncertainty in the average land temperature in the earlier data. Going forward, we will only use the data after 1900.
Overall, across all seasons, there seems to be an increasing trend in average land temperature after roughly 1975. 

```{r filter-years, echo = FALSE}
df <- df %>%
  filter(dt >= "1900-01-01")
```



```{r temp-oceans, echo = FALSE}
ggplot(data=df, aes(x=dt, y=LandAndOceanAverageTemperature)) +
  geom_point(aes(color=season)) + 
  labs(title = "Global average land + ocean temperature since 1900",
       x = "Year",
       y = "Average Land + Ocean Temp.")
```
Based on the second visualization, the average land/ocean temperature seems to increase more steeply after 1975 than the average land temperature. The values for spring and autumn in the land/ocean data are also much more similar than they are for just land.


```{r annual-avg-viz, echo = FALSE}
annual_avg <- df %>%
  group_by(year) %>%
  summarize(avg = mean(LandAverageTemperature),
            max_avg = mean(LandMaxTemperature),
            min_avg = mean(LandMinTemperature)) 

ggplot(data=annual_avg, aes(x=year, y=avg)) +
  geom_point(aes(color=avg), size=2) + 
  labs(title = "Global average land temperature since 1900",
       x = "Year",
       y = "Average Land Temp.")
```
When we plot the average annual land temperature (an average of the data points from each month), we can visualize a more extreme change in average land temperature over time than when each month is plotted individually. This is marked by a more severe uptick since 1980.

```{r facet-season, echo = FALSE}
ggplot(data=df, aes(x=dt, y=LandAverageTemperature)) +
  geom_point(aes(color=LandAverageTemperature), size=.5) + 
  facet_wrap(~season)
```

```{r highs-lows-visualization, echo = FALSE}
ggplot(data=annual_avg, aes(x = year)) +
  geom_line(aes(y = max_avg)) +
  geom_line(aes(y = min_avg))
```

The upward trend visualized in the first few graphs is consistent over each season, as well as for the annual average temperature highs and lows.



```{r country-avg-changes, echo = FALSE}
bycountrypre1950 <- df %>%
  filter(!is.na(AverageTemperature),
         year < 1950) %>%
  group_by(Country) %>%
  summarize(avg = mean(AverageTemperature))

bycountry2010s <- df %>%
  filter(!is.na(AverageTemperature),
         year > 2009) %>%
  group_by(Country) %>%
  summarize(avg = mean(AverageTemperature))

changesbycountry <- tibble(country=bycountry2010s$Country, 
                           change = bycountry2010s$avg - bycountrypre1950$avg) 


```

```{r visualization-by-country, echo = FALSE}
ggplot(data=changesbycountry,aes(x=reorder(country,-change),y=change)) +
  geom_bar(stat="identity", aes(fill=change)) + 
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    title="Average change from pre-1950 data to post-2010 data, by country",
    x="Country")
```
In this visualization we can see the countries that have had the greatest change in average temperature from before 1950 to 2010-2013.

### Results

**Research question 1:**
$H_o$: The difference between mean earth surface temperature in recent years 
(1980-2013) and the mean earth surface temperature throughout the 20th century 
is not greater than the differences observed during the rest of the 20th 
century.  

$H_a$: The difference between mean earth surface temperature in recent years 
(1980-2013) and the mean earth surface temperature throughout the 20th century 
is greater than the differences observed during the rest of the 20th century.

```{r differences-for-loop, echo = FALSE}
differences <- c(nrow(annual_avg))

for (i in 1:nrow(annual_avg) - 1) {
  differences[i] <- annual_avg$avg[i+1] - annual_avg$avg[i]
}

```

```{r differences-create-df, echo = FALSE}
differences <- tibble(differences)
differences <- tibble::rowid_to_column(differences, "year")
differences <- differences %>%
  mutate(year = 1900 + year)

```

```{r differences-viz, echo = FALSE}
ggplot(data=differences, aes(x=year, y=differences)) +
  geom_bar(stat="identity") +
  labs(title = 
         "Year-to year differences in annual average temperatures since 1900")
```
Based on this visualization, someone could potentially try to counter the argument for the existence of climate change, because there is a large fluctuation of positive and negative changes from year to year. Therefore, we then created a new dataframe to measure the overall difference between each year's average temperature and the average temperature across the 20th century, as shown below.

```{r compare-to-20th-century, echo = FALSE}
avg_20thcentury <- annual_avg %>%
  summarize(mean(avg)) %>%
  pull()

comp <- c(nrow(annual_avg))

for (i in 1:nrow(annual_avg) - 1) {
  comp[i] <- annual_avg$avg[i+1] - avg_20thcentury
}

comparison_to_20th <- tibble(comp)
comparison_to_20th <- tibble::rowid_to_column(comparison_to_20th, "year")
comparison_to_20th <- comparison_to_20th %>%
  mutate(year = 1900 + year)
```

```{r visualization-compare-to-avg, echo = FALSE}
ggplot(data=comparison_to_20th, aes(x=year, y=comp)) +
  geom_bar(stat="identity", aes(fill=comp)) +
  labs(title=
         "Differences between average annual temp. and 20th century avg.",
       y = "Amount of change")
```

```{r q-1-bootstrap, echo = FALSE}
post1980 <- comparison_to_20th %>%
  filter(year >= 1980)

set.seed(7)

boot_dist <- numeric(5000)
for (i in 1:5000) {
  indices <- sample(1 : nrow(post1980), replace = TRUE)
  boot_diff <- post1980 %>%
    slice(indices) %>%
    summarize(mean(comp)) %>%
    pull()
  boot_dist[i] <- boot_diff
}
boot_dist <- tibble(boot_dist)
```

```{r q-1-testing, echo = FALSE}
obs_diff <- post1980 %>%
  summarize(mean(comp)) %>%
  pull()

boot_mean <- boot_dist %>%
  summarize(mean(boot_dist)) %>%
  pull()

obs_diff

shifted <- boot_dist %>%
  mutate(shifted = boot_dist - boot_mean)

shifted %>%
  mutate(extreme = if_else(shifted >= obs_diff, 1, 0)) %>%
  summarize(p_val = mean(extreme)) %>%
  pull()
```

```{r q-1-visualization, echo = FALSE}
ggplot(data = shifted, aes(x = shifted)) +
  geom_histogram(color = "darkblue", fill = "lightblue",bins=40) +
  geom_vline(xintercept = obs_diff, color = "red", lwd=1) +
  labs(title = "Simulated null distribution of differences:",
       subtitle = "average annual land temp. minus 20th century average temp.",
       x = "mean difference in temperature"
         )
```

```{r q-1-clt, echo = FALSE}
comparison_to_20th <- comparison_to_20th %>%
  mutate(post1980 = year >= 1980)

t.test(comp ~ post1980,
  data = comparison_to_20th,
  mu = 0,
  var.equal = FALSE,
  alternative = "less",
  conf.level = 0.95)
```

According to both a CLT-based and a simulation-based approach, the p-value is 
under $\alpha = 0.01$, so we reject this null hypothesis.

The p-value in this approach is the probability of obtaining results in which 
the post-1980 data exhibit at least the observed difference between the average 
annual temperature and the average 20th century temperature. From both tests, 
the p-value was extremely small: we observed a 0 p-value in the simulation-based 
approach. 

In context of our question, this indicates that there is evidence to support a 
statistically significant increase in temperature over the 20th century. This is
important because this is one of the main arguments used against climate change.


**Research question 2:**
$H_o$: The global average earth surface temperature changed at the same rate 
from 1975-2013 as it did from 1900-1925.

$H_a$: The global average earth surface temperature changed at a greater rate 
from 1975-2013 than it did from 1900-1925.

```{r q-2-lm, echo = FALSE}
comparison_to_20th <- comparison_to_20th %>%
  mutate(time_period = case_when(
    year >= 1900 & year < 1925 ~ "year19001925",
    year >= 1925 & year < 1950 ~ "year19251950",
    year >= 1950 & year < 1975 ~ "year19501975",
    year >= 1975 ~ "post1975"
  ))

m_main <- lm(comp ~ year + post1980, data=comparison_to_20th)
tidy(m_main) %>%
  select(term, estimate)

m_int_1980 <- lm(comp ~ year + post1980 + year*post1980, data=comparison_to_20th)
tidy(m_int_1980)

m_int <- lm(comp ~ year + time_period + year*time_period, data=comparison_to_20th)
tidy(m_int)
```

$$\widehat{TempDiff} = -11.958 + 0.00605 year - 47.857  post1980 + 0.0242 year 
\times post1980$$
Pre-1980:
$$\widehat{TempDiff} = -11.958 + 0.00605 year $$

Post-1980:
$$\widehat{TempDiff} = -59.815 + 0.03025 year $$


```{r q-2-viz, echo = FALSE}
ggplot(data=comparison_to_20th, aes(x=year, y=comp, color=time_period)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE) 
```

```{r q-2-testing, echo = FALSE}
slopes <- comparison_to_20th %>%
  mutate(year_category = 
    for(y:year){
      //5 * 5
    }
  ))
  m_main <- lm(comp ~ year,
                 data = comparison_to_20th) %>%
  tidy(m_main) %>%
    select(term,estimate)

set.seed(12)

boot_dist_slope <- numeric(5000)
for (i in 1:5000) {
  indices <- sample(1 : nrow(), replace = TRUE)
  boot_diff <- post1980 %>%
    slice(indices) %>%
    m_main <- lm(comp ~ year,
                 data = )
  tidy(m_main)%>%
    select(term,estimate) %>%
    pull()
  boot_dist_slope[i] <- boot_diff
}
boot_dist_slope <- tibble(boot_dist_slope)
```


----------------------------------------------------------------------
How can we hypothesis test this?
We can try to do a simulation where we run the linear model over maybe like 
every 5-year period and compare the slopes?

basically we would have to run the linear model each time a for-loop is run
and then extract the slope somehow, then compare it against the slope for the 
overall linear model if we were to use one straight line to model land temp. 
increases, then store that difference in our simulated null distribution.

there is a way to extract the slope from the linear model to use it in calculations
but i didn't have time to implement it



**Research Question 3:**

$H_o$
Latitude and temperature change are independent; there is no correlation.

$H_a$
Latitude and temperature change are not independent; there is a correlation 
between latitude and the amount of observed temperature change.























(only if we have time)

Linear model(s) for land temperature change and land+ocean temperature change?


$H_o$ = There is no variation in earth surface temperature change 
geographically.

$H_a$ = There is variation in earth surface temperature change geographically.


$H_o$
Canada has experienced earth surface temperature change to the same degree as 
the global average.

$H_a$
Canada has experienced a greater amount of earth surface temperature change 
than the global average.

### Discussion

Throughout our analysis, we saw clear evidence that climate change exists and 
that global land and ocean temperatures are increasing at an unprecedented 
extent. As seen in our earlier visualizations, there is visual evidence that
the rate of change of temperature has increased, especially since 1975. 
However, we were also able to use hypothesis testing to support climate change.
In our first hypothesis test, we found evidence that the mean Earth temperature
from 1980 to 2013 is greater than the mean Earth temperatures in the 20th 
century.

** Add the outcomes of our other hypothesis tests once we finish them



