---
title: "Project - Team 10-7"
author: "The Outliers: Morgan Pruchniewski, Scott Burstein, Katie Zhou"
date: "10/6/2020"
output: 
  pdf_document: default
  html_document: default
---

```{r setup, message = FALSE, warning = FALSE, echo = FALSE}
library(tidyverse) 
library(lubridate)
library(maps)
library(sp)
library(RColorBrewer)
library(paletteer)
library(ggthemes)
```
# Introduction

One of the biggest environmental issues facing our planet has been climate
change. As fossil fuel emissions have increased, greenhouse gases have begun
trapping heat in our atmosphere that has created severe impacts. These include
increased global temperature and rising ocean levels, in addition to increased
natural disasters (https://climate.nasa.gov/effects/).
(https://www.usgs.gov/faqs/how-can-climate-change-affect-natural-disasters-1?
qt-news_science_products=0#qt-news_science_products)

Climate change is a significant issue that has also become a hot-button 
political topic in recent years because of the failure of certain individuals, 
political parties, and corporations to take action: some people do in fact deny 
the existence of climate change/global warming despite a strong body of 
scientific support. 
(https://www.sciencealert.com/the-five-corrupt-pillars-of-climate-change-denial) 
The main argument behind this is that the Earth is always 
changing, and that the recent increase in global land and ocean temperatures
is not significant enough to support global warming.

In this report, we will be analyzing a dataset containing recorded land and 
ocean temperatures over the last 100+ years to examine whether there is evidence 
to suggest a statistically significant increase in land temperature over the 
last 30 years. 

### Research Questions:
Our main research question will be:  
**Is there significant evidence to support the existence of climate change?**  

To evaluate this, we will conduct comprehensive hypothesis tests on four sub-questions.

*1: Is there evidence to suggest a statistically significant increase in mean
earth surface temperature from early-20th-century levels to what the data show for more recent years?*. 

For this question, we will use $\alpha = 0.01$.  
Our hypotheses for this question are as follows:  
$H_a:$
The mean anomaly of annual temperature averages with respect to the average temperature
before 1980 is not greater than 0 (the mean value from before 1980 is used
as the reference value for calculating anomalies, so the mean anomaly of pre-1980 values is assumed to be 0).  


$H_a:$ 
The mean anomaly of annual temperature averages with respect to the average temperature
before 1980 is greater than 0 (the mean anomaly of data before 1980 with respect
to its average temperature).



We predict that there will be sufficient evidence to support a statistically significant increase as detailed
above, which brings us to the next question:  

*2: Is the earth changing/increasing temperature at a faster rate now than it was in 
the early 20th century?*

For this question, we will record the observed average rates of change (slope) for every
five-year period, and test whether the mean slope after 1980 is greater than the mean slope before 1980
by a statistically significant margin. Because there are only 23 five-year segments between 1900 and 2010, we will 
use a lower $\alpha = 0.01$ level of 0.05.

Our hypotheses for this question are as follows:
$H_o$: The rate at which the average global land temperature increased after 1980 
is not greater than the rate of temperature increase starting from 1900
based on their respective linear models.

$H_a$: The rate at which the average global land temperature increased after 1980 
is greater than the rate of temperature increase starting from 1900
based on their respective linear models.  


Relating to the previous question, which looks at the rates of presumed increase, we will also
evaluate net change (positive of negative).  
*3. Do the data provide evidence of a greater degree of net fluctuation from the
overall 20th century average temperature (positive or negative) after 1980 than was present
before 1980? *


Finally, we will evaluate how the changes in earth surface temperature may differ geographically.
With Europe and North America having had large roles in industrialization, globalization, and technological developments, all of which have been cited as major contributors to climate change, we wanted to consider if this might be manifested
in the amount of climate change exhibited in the last century in those continents.

*4. Has North America experienced a greater change in annual average temperatures from the first half
of the 20th century to 2010 than other continents? Has Europe?*

Our hypotheses for this two-part question are as follows:
North America -  
$H_{o}$: The change in mean temperature from before 1950 to post-2010 in North America 
is equal to the change in temperature observed in the rest of the world.  

$H_{a}$: The change in mean temperature from before 1950 to post-2010 in North America 
is not equal to the change in temperature observed in the rest of the world.  


Europe -  
$H_{o}$: The change in mean temperature from before 1950 to post-2010 in Europe
is equal to the change in temperature observed in the rest of the world.  

$H_{a}$: The change in mean temperature from before 1950 to post-2010 in Europe
is not equal to the change in temperature observed in the rest of the world.


### The Data:
We found this dataset on Kaggle (https://www.kaggle.com/berkeleyearth/climate-change-earth-surface-temperature-data).
The data was originally compiled by the Berkeley Earth Data Lab from 
16 pre-existing archives, and it was updated to Kaggle in 2017. It is important
to note that many of the earlier years include NA values, which is why we 
focused on analysis on the 1900s.

### The Cases:

**(By Time and Location (for `GlobalLandTemperaturesByMajorCity`))**

Each observation in `GlobalLandTemperaturesByMajorCity` is a city and its 
respective land temperature, coordinates, and Country, which will be used to 
investigate changes in climate over time. There are 239,177 rows in the major 
city dataset. 

**(By Time (for `GlobalLandTemperaturesByMajorCity`))**

Each observation in `GlobalTemperatures` is a numeric date/time value 
(described below) and its respective land temperature, max temperature, 
min temperature, ocean temperature, and relevant uncertainties to said 
variables, which will be used to investigate changes in climate over time. 
There are 3,192 rows in the global dataset. 

### Relevant Variables:

The relevant variables in the `major_city` dataset include dt (date and time of 
the recorded temperature, a discrete numeric), AverageTemperature (the average 
temperature for each city, a continuous numeric), city (nominal categorical), 
country (nominal categorical), latitude (continuous numeric), and longitude 
(continuous numeric).

The relevant variables in the `global` dataset include dt (date and time of the 
recorded temperature, a discrete numeric), LandAverageTemperature (the average 
global land temperature at that time, continuous numeric), LandMaxTemperature 
(the highest recorded land temperature of that year, a continuous numeric), 
LandMinTemperature (the lowest recorded land temperature of that year, a 
continous numeric), and LandAndOceanAverageTemperature (the average of land and 
ocean temperature averages for that year, a continuous numeric).

```{r read-in-data, message = FALSE, echo = FALSE}
#read in datasets
major_city <- read_csv("data/GlobalLandTemperaturesByMajorCity.csv")
global <- read_csv("data/GlobalTemperatures.csv",
                    col_types = "Tdddddddd")
df <- left_join(major_city, global) 
```

```{r data-processing, echo = FALSE}
df$Latitude<-as.numeric(gsub("N|E|S|W", "",df$Latitude))*
  ifelse(grepl("S",df$Latitude),-1,1)

df$Longitude<-as.numeric(gsub("N|E|S|W", "",df$Longitude))*
  ifelse(grepl("W",df$Longitude),-1,1)

df <- df %>%
  mutate(month = month(dt),
         year = year(dt),
         season = case_when(
           month < 3 | month == 12 ~ "winter",
           month >= 3 & month < 6 ~ "spring",
           month >=6 & month < 9 ~ "summer",
           month >= 9 & month < 12 ~ "autumn"
         )) 

df$Country <- replace(df$Country, df$Country=="Congo (Democratic Republic Of The)","Congo")
 
```


### Methodology

***Initial visualizations:***
```{r ggplot-theme}
theme_economist_mod <- function() {
  theme_economist() + 
  theme(
    rect = element_rect(fill = "#E5E9F0", colour = NA,
                              linetype = 1),
    panel.background = element_rect(linetype = 0),
    plot.background = element_rect(fill = "#E5E9F0", colour = NA),
    line = element_line(colour = "white"),
    axis.line = element_line(size = rel(1.5)),
    axis.title.y = element_text(margin = unit(c(0, 2, 0, 0), "mm")),
    axis.title.x = element_text(margin = unit(c(4, 0, 0, 0), "mm")))
}

seasoncolors <- c("summer" = "#D08770","autumn" = "#EBCB8B",
             "winter" = "#88C0D0","spring" = "#B48EAD")
gradientcolors <- c(
  "#B48EAD","#5E81AC","#A3BE8C","#EBCB8B","#D08770","#BF616A")
```


```{r visualization-by-season, echo = FALSE}
ggplot(data=df, aes(x=dt, y=LandAverageTemperature)) +
  geom_point(aes(color=season), size=0.8) +
  labs(title = "Global average land temperatures since 1849",
       x = "Year",
       y = "Average land temp.",
       color = "Season") +
  scale_color_manual(values=seasoncolors) +
  theme_economist_mod() +
  guides(col = guide_legend(override.aes = list(size=4)))
```
Based on this initial visualization, there seems to be a high amount of uncertainty in the average land temperature in the earlier data. Going forward, we will only use the data after 1900.
Overall, across all seasons, there seems to be an increasing trend in average land temperature after roughly 1975. 

```{r filter-years, echo = FALSE}
df <- df %>%
  filter(dt >= "1900-01-01")
```



```{r temp-oceans, echo = FALSE}
ggplot(data=df, aes(x=dt, y=LandAndOceanAverageTemperature)) +
  geom_point(aes(color=season), size=0.8) + 
  labs(title = "Global average land + ocean temperatures since 1900",
       x = "Year",
       y = "Average land + ocean temp.",
       color="Season") + 
  scale_color_manual(values=seasoncolors) +
  theme_economist_mod() +
  guides(col = guide_legend(override.aes = list(size=4)))
```
Based on the second visualization, the average land/ocean temperature seems to increase more steeply after 1975 than the average land temperature. The values for spring and autumn in the land/ocean data are also much more similar than they are for just land.


```{r annual-avg-viz, echo = FALSE}
annual_avg <- df %>%
  group_by(year) %>%
  summarize(avg = mean(LandAverageTemperature),
            max_avg = mean(LandMaxTemperature),
            min_avg = mean(LandMinTemperature)) 

ggplot(data=annual_avg, aes(x=year, y=avg)) +
  geom_point(aes(color=avg), size=3) + 
  labs(title = "Global average land temperatures since 1900",
       x = "Year",
       y = "Average land temp.") +
  theme_economist_mod() +
  scale_colour_gradientn(colours = gradientcolors) + 
  theme(legend.position="right")

```
When we plot the average annual land temperature (an average of the data points from each month), we can visualize a more extreme change in average land temperature over time than when each month is plotted individually. This is marked by a more severe uptick since 1980.

```{r facet-season, echo = FALSE}
ggplot(data=df, aes(x=dt, y=LandAverageTemperature)) +
  geom_point(aes(color=LandAverageTemperature), size=.3) + 
  facet_wrap(~season) +
  labs(title="Global average land temperatures",
       subtitle="faceted by season",
       y="Average land temp.",
       x = "Year",
       color = "Average \nland temp.") +
  theme_economist_mod() +
  scale_colour_gradientn(colours = gradientcolors) +
  theme(legend.position="right")
```

```{r highs-lows-visualization, echo = FALSE}
ggplot(data=annual_avg, aes(x = year)) +
  geom_line(aes(y = max_avg), color="#5E81AC", size=0.3) +
  geom_line(aes(y = min_avg), color="#5E81AC", size=0.3) + 
  geom_point(aes(y = max_avg), size=0.6, color="#434C5E") +
  geom_point(aes(y = min_avg), size=0.6, color="#434C5E") +
  labs(title = "Annual global average highs and lows",
       x = "Year",
       y = "Average global extremes") +
  theme_economist_mod() +
  theme(
    axis.title.y = element_text(margin = unit(c(0, 2, 0, 0), "mm"))
  )
```
  
The upward trend visualized in the first few graphs is consistent over each season, as well as for the annual average temperature highs and lows.



```{r country-avg-changes, echo = FALSE, message=FALSE}
bycountrypre1950 <- df %>%
  filter(!is.na(AverageTemperature),
         year < 1950) %>%
  group_by(Country) %>%
  summarize(avg = mean(AverageTemperature),
            lat = mean(Latitude),
            long = mean(Longitude)) 
  

bycountry2010s <- df %>%
  filter(!is.na(AverageTemperature),
         year > 2009) %>%
  group_by(Country) %>%
  summarize(avg = mean(AverageTemperature),
            lat = mean(Latitude),
            long = mean(Longitude))

changesbycountry <- tibble(country=bycountry2010s$Country, 
                           change = bycountry2010s$avg - bycountrypre1950$avg,
                           lat = bycountry2010s$lat,
                           long = bycountry2010s$long) 


```

```{r visualization-by-country, echo = FALSE}
legend_mod <- function() {
  theme(legend.position="right",
        legend.title = element_text(size=10),
        legend.title.align = 1,
        legend.text = element_text(size=8),
        legend.box.spacing = unit(0.05, "cm"),
        legend.margin = margin(0,0,0,0, "cm"),
        legend.key.size = unit(0.5,"cm")) 
}

ggplot(data=changesbycountry,aes(x=reorder(country,-change),y=change)) +
  geom_bar(stat="identity", aes(fill=change)) + 
  labs(
    title="Average change from pre-1950 data to post-2010 data",
    subtitle = "by country",
    x="Country",
    y = "Change in average temperature",
    fill = "Change in \naverage \ntemp.") + 
  theme_economist_mod() +
  theme(axis.title.y = element_text(margin = unit(c(0, 1, 0, 0), "mm")),
    axis.text.x = element_text(angle = 90, size = 8,hjust=1),
    plot.subtitle = element_text(size = 17, hjust = 0.07, vjust = 0.5)) +
  scale_fill_gradientn(colours = gradientcolors) +
  legend_mod() +
  guides(fill = guide_colorbar(label.position = "left"),label.hjust=1) 
  
```
In this visualization we can see the countries that have had the greatest change in average temperature from before 1950 to 2010-2013.

### Results

**Question 1:**. 
*Is there evidence to suggest a statistically significant increase in mean
earth surface temperature from early-20th-century levels to what the data show for more recent years?*


$H_o: \mu_{post1980} \leq \mu_{pre1980}$ 
Null hypothesis:  
The mean anomaly of annual temperature averages with respect to the average temperature
before 1980 is not greater than 0 (the mean value from before 1980 is used
as the reference value for calculating anomalies, so the mean anomaly of pre-1980 values is assumed to be 0). 


$H_a: \mu_{post1980} > \mu_{pre1980}$ 
Alternative hypothesis:  
The mean anomaly of annual temperature averages with respect to the average temperature
before 1980 is greater than 0 (the mean anomaly of data before 1980 with respect
to its average temperature).

```{r per-year-diffs-loop, echo = FALSE}
differences <- c(nrow(annual_avg))

for (i in 1:nrow(annual_avg) - 1) {
  differences[i] <- annual_avg$avg[i+1] - annual_avg$avg[i]
}

```

```{r per-year-diffs-create-df, echo = FALSE}
differences <- tibble(differences)
differences <- tibble::rowid_to_column(differences, "year")
differences <- differences %>%
  mutate(year = 1900 + year)

```

```{r per-year-diffs-viz, echo = FALSE}
ggplot(data=differences, aes(x=year, y=differences)) +
  geom_bar(aes(fill=differences), stat="identity") +
  labs(title = 
         "Year-to year differences in annual \naverage temperatures since 1900",
       fill = "Differences",
       x = "Year",
       y = "Change in annual avg. from previous year") + 
  theme_economist_mod() + 
  scale_fill_gradientn(colours = c("#EBCB8B","#D08770", "#BF616A")) +
  legend_mod()
```
Based on this visualization, someone could potentially try to counter the argument for the existence of climate change, because there is a large fluctuation of positive and negative changes from year to year. Therefore, we then created a new data-frame to measure the overall difference between each year's average temperature and the average temperature across the 20th century, as shown below, and are using the comparison to the 20th century average for our hypothesis test.


```{r create-anomalies-data, echo = FALSE}
avg_to1980 <- annual_avg %>%
  filter(year < 1980) %>%
  summarize(mean(avg)) %>%
  pull()

annual_avg <- annual_avg %>%
  mutate(anomaly = avg - avg_to1980,
         post1980 = year >= 1980)
```

```{r visualization-anomalies, echo = FALSE}
ggplot(data=annual_avg, aes(x=year, y=anomaly)) +
  geom_bar(stat="identity", aes(fill=anomaly)) +
  labs(title=
  "Anomalies of average temperatures \nwith respect to 1900-1980 average",
    x = "Year",
    y = "Difference from 1900-1980 average",
    fill = "Difference amount") + 
  theme_economist_mod() + 
  scale_fill_gradientn(colours = gradientcolors) +
  legend_mod()
```

```{r anomaly-bootstrap, echo = FALSE}
post <- annual_avg %>%
  filter(post1980 == TRUE) 

pre <- annual_avg %>%
  filter(post1980 == FALSE)

set.seed(7)

boot_dist <- numeric(5000)

for (i in 1:5000) {
  post_mean <- post %>%
    slice(sample(1:nrow(post), replace = TRUE)) %>%
    summarize(mean(anomaly)) %>%
    pull()
  pre_mean <- pre %>%
    slice(sample(1:nrow(pre), replace = TRUE)) %>%
    summarize(mean(anomaly)) %>%
    pull()
  boot_dist[i] <- post_mean - pre_mean
}

boot_dist <- tibble(boot_dist)
boot_dist
```

```{r anomaly-ci}
diff_bootstrap_interval <- boot_dist %>%
  summarize(lower = quantile(boot_dist, 0.005),
            upper = quantile(boot_dist, 0.995)
            )
diff_bootstrap_interval
```
Our 99% confidence interval for this hypothesis test is (0.5514, 0.8941).
We can be 99% confident that the true mean anomaly of annual temperature averages after 1980 with respect to the average temperature before 1980 is between these bounds.


```{r anomaly-testing, echo = FALSE}
pre_mean <- pre %>%
  summarize(mean(anomaly)) %>%
  pull()

post_mean <- post %>%
  summarize(mean(anomaly)) %>%
  pull()

obs_diff <- post_mean - pre_mean

boot_mean <- boot_dist %>%
  summarize(mean(boot_dist)) %>%
  pull()

obs_diff
boot_mean

shifted <- boot_dist %>%
  mutate(shifted = boot_dist - boot_mean)

shifted %>%
  mutate(extreme = if_else(shifted >= obs_diff, 1, 0)) %>%
  summarize(p_val = mean(extreme)) %>%
  pull()
```

```{r compare-to-20th-sim-viz, echo = FALSE}
ggplot(data = shifted, aes(x = shifted)) +
  geom_histogram(color = "#4C566A", fill = "#88C0D0",bins=50) +
  geom_vline(xintercept = obs_diff, color = "#BF616A", lwd=1) +
  annotate("text", 
           x = obs_diff - 0.045, y = 350, 
           label= paste("Observed difference: \n", round(obs_diff, 4)),
           angle = 90, size = 5) + 
  labs(title = "Simulated null distribution of post-1980 anomalies",
       subtitle = 
         "Average annual land temp. after 1980 minus average temp. before 1980",
       x = "Mean difference in temperature",
       y = "Count") +
  theme_economist_mod() 
```

```{r compare-to-20th-clt, echo = FALSE}
t.test(anomaly ~ post1980,
  data = annual_avg,
  mu = 0,
  var.equal = FALSE,
  alternative = "less",
  conf.level = 0.99)

```

In both approaches used in this analysis, the p-value is well under $\alpha = 0.01$, 
so we reject this null hypothesis.

The p-value in this approach is the probability of obtaining results in which 
the post-1980 data exhibit an anomaly with respect to the pre-1980 average temperature 
as large as observed or greater, assuming under the null hypothesis that the post-1980
temperatures are not significantly different from the pre-1980 temperatures. From both tests, the p-value was extremely small: we observed a 0 p-value in the simulation-based 
approach. 

In context of our question, this indicates that there is evidence to support a 
statistically significant increase in temperature over the 20th century. This is
important because this is one of the main arguments used against climate change.


**Question 2:**
*Is the earth changing/increasing temperature at a faster rate now than it was in 
the early 20th century?*

$H_o: \beta_{post1980} \leq \beta_{pre1980}$ 
Null hypothesis:  
The rate at which the average global land temperature increased after 1980 
is not greater than the rate of temperature increase starting from 1900
based on their respective linear models.


$H_a: \beta_{post1980} > \beta_{pre1980}$ 
Alternative hypothesis:  
The rate at which the average global land temperature increased after 1980 
is greater than the rate of temperature increase starting from 1900
based on their respective linear models.

```{r time-period-lm, echo = FALSE}
m_main <- lm(avg ~ year, data=annual_avg)
tidy(m_main) %>%
  select(term, estimate)

m_int_1980 <- lm(avg ~ year + post1980 + year*post1980, data=annual_avg)
tidy(m_int_1980)%>%
  select(term, estimate)

```
Overall regression:
$$\widehat{TempDiff} = -12.204 + 0.0107 \times year$$

Interaction model for pre- and post-1980:
$$\widehat{TempDiff} = -2.836 + 0.00587 year - 48.226 post1980 + 0.0243 year 
\times post1980$$

Pre-1980:
$$\widehat{TempDiff} = -2.836 + 0.00587 year$$


Post-1980:
$$\widehat {TempDiff} = -51.0624 + 0.0302 year $$



```{r 1980-lm-viz, echo = FALSE}
ggplot(data=annual_avg, aes(x=year, y=avg, color=post1980)) +
  geom_point(size = 5, alpha = 0.7) +
  geom_smooth(method="lm", se=FALSE, lwd = 2.5) +
  labs(title = "Global average land temperatures since 1900:",
       subtitle = 
         "Linear model for rates of temperature increase before/after 1980",
       x = "Year",
       y = "Average land temp.") +
  scale_color_discrete(name = "Time period", 
                       labels = c("Pre-1980", "Post-1980")) +
  scale_color_manual(values = c("#B48EAD", "#81A1C1")) +
  theme_economist_mod() +
  theme(plot.subtitle = element_text(size = 14, hjust = 0)) + 
  legend_mod()
```

```{r create-slopes-data, echo = FALSE}
set.seed(12)
slopes <- numeric(23)

for (i in 1:23) {
    fiveyrs <- annual_avg %>%
      filter(year >= i*5 + 1895 & year < i*5 + 1900)
    model <- lm(avg ~ year, data=fiveyrs) 
    model <- tidy(model) %>%
      select(estimate) %>%
      slice(2) %>%
      pull()
    slopes[i] <- model
}

slopes <- tibble(slopes)
five_year_slopes <- tibble::rowid_to_column(slopes, "year")
five_year_slopes <- five_year_slopes %>%
  mutate(yearstart = 1895 + 5 * year)
```

``` {r every-five-yrs-viz}
ggplot(data=five_year_slopes, aes(x=slopes)) +
  geom_histogram(bins=23, fill = "#A3BE8C", color = "#728562") +
  labs(title=
         "Distribution of rates of temperature increase",
       subtitle="Linear model for each five-year period",
       x = "Slope (rate of change in avg. earth surface temperature)",
       y = "Count") + 
  scale_x_continuous(breaks=seq(-0.2,0.25,0.05)) +
  theme_economist_mod() +
  theme(plot.subtitle = element_text(size = 14, hjust = 0))
```

```{r 1980-bootstrap-test}
boot_dist_slope <- numeric(5000)
for (i in 1:5000) {
  indices <- sample(1 : nrow(slopes), replace = TRUE)
  boot_diff <- slopes %>%
    slice(indices) %>%
      summarize(mean_slope = mean(slopes)) %>%
    pull()
  boot_dist_slope[i] <- boot_diff
}

boot_dist_slope <- tibble(boot_dist_slope)

boot_mean_slope <- boot_dist_slope %>%
  summarize(mean = mean(boot_dist_slope)) %>% 
  pull()

post1980slope <- 0.0302

boot_dist_slope %>% 
  mutate(extreme = ifelse(boot_dist_slope >= post1980slope, 1, 0))%>%
  summarize(p_value= mean(extreme))
```
From the above simulation-based test, we found a p-value of 0.0592. Because this is 
not under $\alpha = 0.05$, we fail to reject this null hypothesis.

Here, the p-value is the probability of obtaining results in which the difference in
average rate of change between post- and pre-1980 temperatures is at least as great as what was observed 
in the data.

In context of our question, this suggests we may have insufficient evidence of a statistically
significant increase in the average degree of temperature change from before 1980 to after 1980. 


After failing to reject the null hypothesis above, we then considered performing the same test for the data before and after the year 2000. The linear model as shown below suggests a steeper incline than 1980.
```{r 2000-lm-viz}
ggplot(data=annual_avg, aes(x=year, y=avg, color=post2000)) +
  geom_point(size = 5, alpha = 0.7) +
  geom_smooth(method="lm", se=FALSE, lwd = 2.5) +
  labs(title = "Global average land temperatures since 1900:",
       subtitle = 
         "Linear model for rates of temperature increase before/after 2000",
       x = "Year",
       y = "Average land temp.") +
  scale_color_discrete(name = "Time period", 
                       labels = c("Pre-2000", "Post-2000")) +
  scale_color_manual(values = c("#B48EAD", "#81A1C1")) +
  theme_economist_mod() +
  theme(plot.subtitle = element_text(size = 14, hjust = 0)) + 
  legend_mod()
```

``` {r 2000-bootstrap-test}
post2000slope <- 0.0365

ggplot(data=boot_dist_slope, aes(x=boot_dist_slope)) +
  geom_histogram(bins=50,fill = "#8FBCBB", color = "#648382") +
  geom_vline(xintercept = post1980slope, 
              color = "#BF616A", lwd=1) +
  geom_vline(xintercept = post2000slope, 
              color = "#BF616A", lwd=1) +
  labs(title=
     "Simulated null distribution of mean \nrates of change in temperature",
     x = "Average rate of change (slope)",
     y = "Count") +
    theme_economist_mod()

boot_dist_slope %>% 
  mutate(extreme = ifelse(boot_dist_slope >= post2000slope, 1, 0))%>%
  summarize(p_value= mean(extreme))
```

In the hypothesis test for years after 2000, the p-value is 0.0214, so we can reject this null hypothesis.
This p-value indicates a 0.0214 probability of obtaining results in which the post-2000 data points have a mean 
rate of change equal to or greater than the one observed, assuming that the rates of change truly are equal.

In context of our original research question, this suggests that the earth surface temperature changes that 
we examined in part 1 might be occurring at a quickening pace over time, with a decreasing probability of 
obtaining results as or more extreme as observed (the p-values for the 1980s and 2000s tests). However, it should be noted that there is very limited data after 2000, so this p-value should not
necessarily be interpreted as a practically significant value, and this test alone does not adequately answer
our overall research question.

  
**Question 3:**
*Do the data provide evidence of a greater degree of net fluctuation from the
overall 20th century average temperature (positive or negative) after 1980 than was present
before 1980?*

```{r net-change}
ggplot(data=differences, aes(x=year, y=abs(differences))) +
  geom_bar(aes(fill=differences), stat="identity") +
  labs(title = 
    "Year-to year net differences in \nannual average temperatures since 1900",
       fill = "Net differences",
       x = "Year",
       y = "Change in annual avg. from previous year") + 
  theme_economist_mod() + 
  scale_fill_gradientn(colours = c("#EBCB8B","#D08770", "#BF616A")) +
  legend_mod()

```

$H_o:\mu_{pre1980net} \leq \mu_{post1980net} $ 
Null hypothesis:  
The mean net (absolute value) year-to-year fluctuation in global average surface temperatures after
1980 is not greater than the mean year-to-year fluctuation before 1980.


$H_a:\mu_{pre1980net} > \mu_{post1980net} $ 
Alternative hypothesis:  
The mean net (absolute value) year-to-year fluctuation in global average surface temperatures after
1980 is greater than the mean year-to-year fluctuation before 1980.

```{r net-change-bootstrap}
set.seed(13)

boot_dist <- numeric(5000)
for (i in 1:5000) {
  indices <- sample(1 : nrow(post1980), replace = TRUE)
  boot_diff <- post1980 %>%
    slice(indices) %>%
    summarize(mean(comp)) %>%
    pull()
  boot_dist[i] <- boot_diff
}
boot_dist <- tibble(boot_dist)
```

```{r compare-to-20th-ci}
diff_bootstrap_interval <- boot_dist %>%
  summarize(lower = quantile(boot_dist, 0.005),
            upper = quantile(boot_dist, 0.995)
            )
diff_bootstrap_interval
```
Our 99% confidence interval for this hypothesis test is (0.357, 0.664).
We can be 99% confident that the true mean difference of annual temperature averages and the 20th
century average is between these bounds.


```{r compare-to-20th-testing, echo = FALSE}
obs_diff <- post1980 %>%
  summarize(mean(comp)) %>%
  pull()

boot_mean <- boot_dist %>%
  summarize(mean(boot_dist)) %>%
  pull()

obs_diff

shifted <- boot_dist %>%
  mutate(shifted = boot_dist - boot_mean)

shifted %>%
  mutate(extreme = if_else(shifted >= obs_diff, 1, 0)) %>%
  summarize(p_val = mean(extreme)) %>%
  pull()

```






**Question 4:**

$H_o: \mu_n = \mu_g$
The change in mean temperature from before 1950 to post-2010 in North America is equal to the global change.

$H_a: \mu_n \neq \mu_g$
The change in mean temperature from before 1950 to post-2010 in North America is not equal to the global change.

```{r addcontinent}
changesbycountry %>%
  distinct(country)
  
asia <- c("Afghanistan", "Bangladesh", "Burma", "China", "India","Indonesia",
          "Iran","Iraq","Japan","Pakistan","Philippines","Russia",
          "Saudi Arabia","Singapore","South Korea","Syria","Taiwan","Thailand",
          "Vietnam")
africa <- c("Angola","Congo","Côte D'Ivoire", "Egypt","Ethiopia", "Kenya",
            "Morocco","Nigeria","Senegal","Somalia","South Africa","Sudan",
            "Tanzania","Zimbabwe")
north_america <- c("Canada","Mexico","United States")
south_america <- c("Brazil","Chile","Colombia","Dominican Republic","Peru")
eur <- c("France","Germany","Italy","Spain","Ukraine","United Kingdom",
         "Turkey")
aus <- c("Australia")
  
changesbycountry <- changesbycountry %>%
  mutate(continent = case_when(
    country %in% asia ~ "asia",
    country %in% africa ~ "africa",
    country %in% north_america ~ "north_america",
    country %in% south_america ~ "south_america",
    country %in% eur ~ "eur",
    country %in% aus ~ "aus"
  ), is_europe = continent == "eur",
  is_northamerica = continent == "north_america")



```

```{r ttest-europe}
t.test(change ~ is_europe,
       data = changesbycountry,
       mu = 0,
       var.equal = FALSE,
       alternative = "two.sided",
       conf.level = 0.95)
```

```{r ttest-northamerica}
t.test(change ~ is_northamerica,
       data = changesbycountry,
       mu = 0,
       var.equal = FALSE,
       alternative = "two.sided",
       conf.level = 0.95)
```
From these two hypothesis tests, we fail to reject the null hypothesis that North America has a different 
change in mean temperature from 1950-2010 than the rest of the world. The p-value was 0.268, indicating a .268 probability of observing results in which North America had a difference of overall temperature change at least as extreme as shown in this data set.

However, we constructed a similar t-test for Europe, and when comparing the confidence intervals for the two, comparing Europe to the rest of the world produces a much smaller confidence interval (-.4124, .4133), versus that for North America: (1.2704, 2.0948). Additionally, the p-value for Europe's t-test was 0.9982, indicating a much higher likelihood of Europe having the same true mean change in land temperature as the rest of the world.

------add discussion points about this----












### Discussion

Throughout our analysis, we saw clear evidence that climate change exists and 
that global land and ocean temperatures are increasing at an unprecedented 
extent. As seen in our earlier visualizations, there is visual evidence that
the rate of change of temperature has increased, especially since 1975. 
However, we were also able to use hypothesis testing to support climate change.
In our first hypothesis test, we found evidence that the mean Earth temperature
from 1980 to 2013 is greater than the mean Earth temperatures in the 20th 
century.

** Add the outcomes of our other hypothesis tests once we finish them



